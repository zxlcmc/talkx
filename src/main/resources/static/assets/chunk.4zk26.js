var J=Object.defineProperty;var $=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable;var P=(o,e,t)=>e in o?J(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,z=(o,e)=>{for(var t in e||(e={}))K.call(e,t)&&P(o,t,e[t]);if($)for(var t of $(e))Q.call(e,t)&&P(o,t,e[t]);return o};var y=(o,e,t)=>new Promise((a,n)=>{var s=i=>{try{c(t.next(i))}catch(l){n(l)}},r=i=>{try{c(t.throw(i))}catch(l){n(l)}},c=i=>i.done?a(i.value):Promise.resolve(i.value).then(s,r);c((t=t.apply(o,e)).next())});import{_ as _export_sfc,g as ref,k as useMessage,l as useChatStore,m as useLoginStore,p as useToast,V as useCommunication,a4 as watch,G as nextTick,c as computed,aq as getImgWH,an as __vitePreload,q as onMounted,t as onUnmounted,o as openBlock,a as createElementBlock,e as createBaseVNode,as as separate_symbol,at as v4,ar as optimizeKatex,F as Fragment,x as renderList,A as toDisplayString,i as inject,B as withModifiers,a0 as default_user_avatar,d as createCommentVNode,Y as withDirectives,Z as vShow,b as createBlock,f as createVNode,w as normalizeClass,L as IMG_TYPES}from"./bundle.0.0.2.js?v=0.6036900755232442";import{i as init,H as HighlightJS,P as PhotoSwipeLightbox}from"./chunk.4zk36.js";import{M as MarkdownIt,m as mila,a as mdKatex}from"./chunk.4zk37.js";import{c as copyToClip}from"./chunk.4zk38.js";import"./chunk.4zk22.js";const index="",thinkPlugin=(o,e)=>{const t=(n,s,r,c)=>{const i=n.bMarks[s]+n.tShift[s],l=n.eMarks[s];if(n.src.slice(i,l).trim()!=="<think>")return!1;let p=1,h=s;for(;++h<n.lineMax;){const f=n.bMarks[h]+n.tShift[h],v=n.eMarks[h],m=n.src.slice(f,v).trim();if(m==="<think>")console.log("lv",p),p++;else if(m==="</think>"&&(p--,p===0))break}let g=[];for(let f=s+1;f<h;f++){const v=n.bMarks[f]+n.tShift[f],m=n.eMarks[f];g.push(n.src.slice(v,m))}const w=n.push("math_think","",0);return w.content=g.join(`
`),w.map=[s,h],n.line=h+1,!0},a=function(n,s){let c=n[s].content.replace(/<think>/g,"&lt;think&gt;").replace(/<\/think>/g,"&lt;/think&gt;");return c=o.render(c),`<div class="custom-think active">
            <div class="think-header">
                <div class="text">已深度思考</div>
                <div class="icon">
                    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.14645 5.64645C3.34171 5.45118 3.65829 5.45118 3.85355 5.64645L8 9.79289L12.1464 5.64645C12.3417 5.45118 12.6583 5.45118 12.8536 5.64645C13.0488 5.84171 13.0488 6.15829 12.8536 6.35355L8.35355 10.8536C8.15829 11.0488 7.84171 11.0488 7.64645 10.8536L3.14645 6.35355C2.95118 6.15829 2.95118 5.84171 3.14645 5.64645Z" fill="currentColor"></path></svg>
                </div>
            </div>
            <div class="think-wrapper"><blockquote>${c}</blockquote></div>  
        </div>`};o.block.ruler.after("blockquote","math_think",t,{alt:["paragraph","reference","blockquote","list"]}),o.renderer.rules.math_think=a};function thinkHeaderClick(o){o.target.parentElement.classList.toggle("active")}const defaultOptions={captionContent:".pswp-caption-content",type:"auto",horizontalEdgeThreshold:20,mobileCaptionOverlapRatio:.3,mobileLayoutBreakpoint:600,verticallyCenterImage:!1};class PhotoSwipeDynamicCaption{constructor(e,t){this.options=z(z({},defaultOptions),t),this.lightbox=e,this.lightbox.on("init",()=>{this.pswp=this.lightbox.pswp,this.initCaption()})}initCaption(){const{pswp:e}=this;e.on("change",()=>{this.showCaption(this.pswp.currSlide)}),e.on("calcSlideSize",t=>this.onCalcSlideSize(t)),e.on("slideDestroy",t=>{t.slide.dynamicCaption&&(t.slide.dynamicCaption.element&&t.slide.dynamicCaption.element.remove(),delete t.slide.dynamicCaption)}),e.on("zoomPanUpdate",({slide:t})=>{if(e.opener.isOpen&&t.dynamicCaption){if(t.currZoomLevel>t.zoomLevels.initial?this.hideCaption(t):this.showCaption(t),t.dynamicCaption.element){let a=0;if(t.currZoomLevel<=t.zoomLevels.initial){const n=t.pan.y-t.bounds.center.y;Math.abs(n)>1&&(a=n)}this.setCaptionYOffset(t.dynamicCaption.element,a)}this.adjustPanArea(t,t.currZoomLevel)}}),e.on("beforeZoomTo",t=>{this.adjustPanArea(e.currSlide,t.destZoomLevel)}),e.on("tapAction",t=>{t.originalEvent.target.closest(".pswp__dynamic-caption")&&t.preventDefault()})}adjustPanArea(e,t){e.dynamicCaption&&e.dynamicCaption.adjustedPanAreaSize&&(t>e.zoomLevels.initial?(e.panAreaSize.x=e.dynamicCaption.originalPanAreaSize.x,e.panAreaSize.y=e.dynamicCaption.originalPanAreaSize.y):(e.panAreaSize.x=e.dynamicCaption.adjustedPanAreaSize.x,e.panAreaSize.y=e.dynamicCaption.adjustedPanAreaSize.y))}useMobileLayout(){const{mobileLayoutBreakpoint:e}=this.options;return typeof e=="function"?e.call(this):typeof e=="number"&&window.innerWidth<e}hideCaption(e){if(e.dynamicCaption&&!e.dynamicCaption.hidden){const t=e.dynamicCaption.element;if(!t)return;e.dynamicCaption.hidden=!0,t.classList.add("pswp__dynamic-caption--faded"),e.captionFadeTimeout&&clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{t.style.visibility="hidden",delete e.captionFadeTimeout},400)}}setCaptionYOffset(e,t){e.style.transform=`translateY(${t}px)`}showCaption(e){if(e.dynamicCaption&&e.dynamicCaption.hidden){const t=e.dynamicCaption.element;if(!t)return;e.dynamicCaption.hidden=!1,t.style.visibility="visible",clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{t.classList.remove("pswp__dynamic-caption--faded"),delete e.captionFadeTimeout},50)}}setCaptionPosition(e,t,a){const n=t<=this.options.horizontalEdgeThreshold;e.classList[n?"add":"remove"]("pswp__dynamic-caption--on-hor-edge"),e.style.left=t+"px",e.style.top=a+"px"}setCaptionWidth(e,t){t?e.style.width=t+"px":e.style.removeProperty("width")}setCaptionType(e,t){const a=e.dataset.pswpCaptionType;t!==a&&(e.classList.add("pswp__dynamic-caption--"+t),e.classList.remove("pswp__dynamic-caption--"+a),e.dataset.pswpCaptionType=t)}updateCaptionPosition(e){if(!e.dynamicCaption||!e.dynamicCaption.type||!e.dynamicCaption.element)return;if(e.dynamicCaption.type==="mobile"){this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.element.style.removeProperty("left"),e.dynamicCaption.element.style.removeProperty("top"),this.setCaptionWidth(e.dynamicCaption.element,!1);return}const t=e.zoomLevels.initial,a=Math.ceil(e.width*t),n=Math.ceil(e.height*t);this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.type==="aside"?(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x+a,e.bounds.center.y),this.setCaptionWidth(e.dynamicCaption.element,!1)):e.dynamicCaption.type==="below"&&(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x,e.bounds.center.y+n),this.setCaptionWidth(e.dynamicCaption.element,a))}onCalcSlideSize(e){const{slide:t}=e;let a,n;if(!t.dynamicCaption){t.dynamicCaption={element:void 0,type:!1,hidden:!1};const c=this.getCaptionHTML(t);if(!c)return;t.dynamicCaption.element=document.createElement("div"),t.dynamicCaption.element.className="pswp__dynamic-caption pswp__hide-on-close",t.dynamicCaption.element.innerHTML=c,this.pswp.dispatch("dynamicCaptionUpdateHTML",{captionElement:t.dynamicCaption.element,slide:t}),t.holderElement.appendChild(t.dynamicCaption.element)}if(!t.dynamicCaption.element)return;this.storeOriginalPanAreaSize(t),t.bounds.update(t.zoomLevels.initial),this.useMobileLayout()?(t.dynamicCaption.type="mobile",n=!0):this.options.type==="auto"?t.bounds.center.x>t.bounds.center.y?t.dynamicCaption.type="aside":t.dynamicCaption.type="below":t.dynamicCaption.type=this.options.type;const s=Math.ceil(t.width*t.zoomLevels.initial),r=Math.ceil(t.height*t.zoomLevels.initial);if(this.setCaptionType(t.dynamicCaption.element,t.dynamicCaption.type),t.dynamicCaption.type==="aside"){this.setCaptionWidth(t.dynamicCaption.element,!1),a=this.measureCaptionSize(t.dynamicCaption.element,e.slide);const c=a.x,i=s+t.bounds.center.x;t.panAreaSize.x-i<=c&&(t.panAreaSize.x-=c,this.recalculateZoomLevelAndBounds(t))}else if(t.dynamicCaption.type==="below"||n){this.setCaptionWidth(t.dynamicCaption.element,n?this.pswp.viewportSize.x:s),a=this.measureCaptionSize(t.dynamicCaption.element,e.slide);const c=a.y;if(this.options.verticallyCenterImage)t.panAreaSize.y-=c,this.recalculateZoomLevelAndBounds(t);else{const i=r+t.bounds.center.y,l=t.panAreaSize.y-i,d=t.panAreaSize.y;if(l<=c){t.panAreaSize.y-=Math.min((c-l)*2,c),this.recalculateZoomLevelAndBounds(t);const p=t.panAreaSize.x*this.options.mobileCaptionOverlapRatio/2;n&&t.bounds.center.x>p&&(t.panAreaSize.y=d,this.recalculateZoomLevelAndBounds(t))}}}this.storeAdjustedPanAreaSize(t),this.updateCaptionPosition(t)}measureCaptionSize(e,t){const a=e.getBoundingClientRect();return this.pswp.dispatch("dynamicCaptionMeasureSize",{captionEl:e,slide:t,captionSize:{x:a.width,y:a.height}}).captionSize}recalculateZoomLevelAndBounds(e){e.zoomLevels.update(e.width,e.height,e.panAreaSize),e.bounds.update(e.zoomLevels.initial)}storeAdjustedPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.adjustedPanAreaSize||(e.dynamicCaption.adjustedPanAreaSize={}),e.dynamicCaption.adjustedPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.adjustedPanAreaSize.y=e.panAreaSize.y)}storeOriginalPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.originalPanAreaSize||(e.dynamicCaption.originalPanAreaSize={}),e.dynamicCaption.originalPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.originalPanAreaSize.y=e.panAreaSize.y)}getCaptionHTML(e){if(typeof this.options.captionContent=="function")return this.options.captionContent.call(this,e);const t=e.data.element;let a="";if(t){const n=t.querySelector(this.options.captionContent);if(n)a=n.innerHTML;else{const s=t.querySelector("img");s&&(a=s.getAttribute("alt"))}}return a}}const TextComp_vue_vue_type_style_index_0_lang="",TextComp_vue_vue_type_style_index_1_scoped_62a2ee11_lang="",_hoisted_1$3=["id"],_hoisted_2$3=["innerHTML"],_sfc_main$3={__name:"TextComp",props:{text:String,type:String,mtype:String,chat:{type:Array,default:[]},cursor:Boolean},setup(__props){let unTextWatch=()=>{};const textRef=ref(null),echartOptions=[],message=useMessage(),useChat=useChatStore(),useLogin=useLoginStore(),{showToast}=useToast(),{send}=useCommunication(),themeObj={dark:"dark",light:""},props=__props;watch([()=>props.chat[1],()=>useChat.sending],()=>{var o;props.type=="answer"&&((o=props.chat[1])!=null&&o.showEchart)&&!useChat.sending&&props.chat[1].content.includes("```echarts")&&nextTick(()=>{document.querySelectorAll(`.text_wrapper[msg-id="${props.chat[1].id}"] .code-block-header__echart`)})});const getEchartDefaultConfig=item=>{let config=Object.assign({grid:{left:"20",right:"20",bottom:"20",containLabel:!0}},eval("("+item.options+")"));return config};watch(()=>useLogin.theme,()=>{echartOptions.forEach(o=>{var e;o.show&&o.chart&&((e=o.chart)==null||e.dispose(),o.chart=init(o.chartDom,themeObj[useLogin.theme]),o.chart.setOption(getEchartDefaultConfig(o),!0))})});const share=computed(()=>props.mtype==="share");computed(()=>props.type=="answer"&&props.loading);const resize=()=>{echartOptions.forEach(o=>{o.show&&o.chart&&o.chart.resize()})},copyEvent=function(o){var a,n;const t=(n=(a=o.target.parentElement)==null?void 0:a.nextElementSibling)==null?void 0:n.textContent;t&&copyToClip(t.trim()).then(()=>message.success("复制成功"))},insetEvent=function(o){var a,n;const t=(n=(a=o.target.parentElement)==null?void 0:a.nextElementSibling)==null?void 0:n.textContent;t&&send("insert-code",t.trim(),()=>{},(s,r)=>{showToast("feature",r)})},contrastEvent=function(o){var a,n;const t=(n=(a=o.target.parentElement)==null?void 0:a.nextElementSibling)==null?void 0:n.textContent;if(t&&props.chat[1]){const s=props.chat[1].editer;console.log("对比",{editer:s,code:t}),send("open-ai-response-in-diff-view",{editer:s,code:t.trim()})}},unfoldEvent=function(o){var n,s;const e=o.target,t=(n=e.parentElement)==null?void 0:n.nextElementSibling,a=(s=e.parentElement)==null?void 0:s.parentElement;if(t){const r=e.textContent=="显示";e.textContent=r?"隐藏":"显示",t.classList[r?"remove":"add"]("hide"),a.style.overflow=r?"auto":"hidden"}},hideCodeArea=o=>y(this,null,function*(){yield nextTick();const e=document.querySelectorAll(".MessageBody .quize .code-block-header__unfold");Array.from(e).forEach(t=>{t.textContent="隐藏",unfoldEvent({target:t})})}),showEchart=(o,e,t)=>{try{o.chart||(o.chart=init(e,themeObj[useLogin.theme]),o.chartDom=e),o.chart.setOption(getEchartDefaultConfig(o),!0)}catch(a){console.log("err",a),o.chart=null,console.log("options:",o.options),t()}},chartConfigArr=[{icon:"icon-chart-pie",title:"显示图表"},{icon:"icon-code",title:"显示源码"}],updateIcon=(o,e)=>{const{icon:t,title:a}=chartConfigArr[+e.show],{icon:n}=chartConfigArr[+!e.show];o.classList.remove(n),o.classList.add(t),o.setAttribute("title",a)},echartControl=o=>{var r,c,i;const e=o.target,t=e.getAttribute("eid"),a=(r=e.parentElement)==null?void 0:r.nextElementSibling,n=(i=(c=e.parentElement)==null?void 0:c.nextElementSibling)==null?void 0:i.nextElementSibling,s=echartOptions.find(l=>l.id==t);if(s){const l=()=>{var p;s.show=!1,updateIcon(e,s),a.style.display="block",n.style.display="none",(p=s.chart)==null||p.dispose(),s.chart=null,n.innerHTML=""},d=()=>{s.show=!0,updateIcon(e,s),a.style.display="none",n.style.display="block",showEchart(s,n,()=>{})};s.show?l():d()}},renderEchartIcon=(o,e)=>{const{id:t,show:a}=e,{icon:n,title:s}=chartConfigArr[+a];return`<span ${o} class="block code-block-header__echart iconfont ${n}" eid="${t}" title="${s}"></span> `};function highlightBlock(o,e,t,{code:a}){var h;const n=props.type=="quize",s=e==="echarts";let r={};t&&t.split(separate_symbol).reduce((g,w)=>{const[f,v]=w.split(":");return g[f]=v,g},r);const c=props.chat?(h=props.chat[1])==null?void 0:h.editer:null,i=`style="display:${useChat.sending?"none":"inline"};"`;n&&hideCodeArea();let l=v4(),d="";if(s){const g={id:l,show:!1,options:a};d=renderEchartIcon(i,g),echartOptions.push(g)}const p=[];return r.fileName||p.push(`<span class="code-block-header__lang">${e||""}</span>`),n?p.push(`
      <span class="code-block-header__fileName">${r.fileName||""} ${r.line||""}</span>
      <span class="code-block-header__unfold">隐藏</span>
		`):(p.push(`<span ${i} class="block code-block-header__copy iconfont icon-file-copy" title="复制"></span>`),d&&p.push(d),share.value||useChat.isWeb||s||(p.push(`<span ${i} class="block code-block-header__inset iconfont icon-code" title="插入代码"></span>`),c&&p.push(`<span ${i} class="block code-block-header__contrast iconfont icon-columns" title="对比代码"></span>`))),`<pre class="code-block-wrapper">
      <div class="code-block-header ${props.type}">${p.join("")}</div>
      <code class="hljs code-block-body ${e}">${o}</code>
      ${s?`<div class="code_echarts_wrapper" eid="${l}" ></div>`:""}
	</pre>`}watch([()=>useChat.sending],()=>{if(!props.cursor)return;const o=document.querySelectorAll(".code-block-header__echart,.code-block-header__copy,.code-block-header__inset,.code-block-header__contrast"),e=document.querySelectorAll(".text_cursor");o&&(Array.from(o).forEach(t=>{t.style.display=useChat.sending?"none":"inline"}),useChat.sending||(Array.from(e).forEach(t=>t.remove()),props.cursor&&initphotoswipe()))});const mdi=new MarkdownIt({html:!1,linkify:!0,highlight(o,e,t){if(!!(e&&HighlightJS.getLanguage(e))){const s=e!=null?e:"";return highlightBlock(HighlightJS.highlight(o,{language:s}).value,s,t,{code:o})}const n=HighlightJS.highlightAuto(o).value;return highlightBlock(n,e,void 0,{code:o})}});mdi.use(thinkPlugin);let isImage=!1;mdi.renderer.rules.image=function(o,e,t,a,n){const s=o[e].attrs[o[e].attrIndex("src")][1],r=o[e].content;isImage=!0;let c="";const i=getImgWH(s);if(!(i instanceof Promise)){const{width:l,height:d}=i;c=`data-pswp-width="${l}" data-pswp-height="${d}"`}return`<div class="gallery__item" url="${s}">
      <a class="md_img" href="${s}" target="_blank" rel="noreferrer" ${c} >
      <img src="${s}?image_process=resize,w_150"  alt="${r}" />
    </a>
  </div>`},mdi.use(mila,{attrs:{target:"_blank",rel:"noopener"}}),mdi.use(mdKatex,{blockClass:"katexmath-block rounded-md p-[10px]",errorColor:" #cc0000"});const preUnify=o=>{const e=document.createElement("div");e.innerHTML=o;const t=e.querySelectorAll("pre");return Array.from(t).forEach(a=>{if(!a.className.includes("code-block-wrapper")){const r="```\n"+a.querySelector("code").innerText+"```";a.outerHTML=mdi.render(r)}}),e.innerHTML};let showTimer;const text=ref(""),readerText=()=>{var t;echartOptions.length=0;let o=(t=props.text)!=null?t:"";o=optimizeKatex(o);const e="P_P_P_P";return props.cursor&&useChat.sending&&(o+=e),props.asRawText||(o=mdi.render(o)),o=o.replace(e,'<span class="text_cursor"></span>'),o=preUnify(o),clearTimeout(showTimer),showTimer=setTimeout(()=>{if(textRef.value&&props.type=="answer"&&(!(useChat.sending&&props.cursor)||!useChat.sending)){const a=textRef.value.querySelectorAll(".code-block-header__echart");Array.from(a).forEach(n=>n&&n.click())}}),o};text.value=readerText(),props.cursor&&useChat.sending&&(unTextWatch=watch([()=>props.text,()=>useChat.sending],()=>{text.value=readerText(),useChat.sending||(unTextWatch(),text.value=readerText(),console.log("回答完成"))}));const events={".code-block-header__copy":{click:[copyEvent]},".code-block-header__echart":{click:[echartControl]},".code-block-header__inset":{click:[insetEvent]},".code-block-header__contrast":{click:[contrastEvent]},".code-block-header__unfold":{click:[unfoldEvent]},".think-header":{click:[thinkHeaderClick]}};let removeEvents=[];const bindEvent=()=>{textRef.value&&(removeEvents.forEach(o=>o.remove()),Object.entries(events).forEach(([o,e])=>{Object.entries(e).forEach(([t,a])=>{const n=s=>{s.target.classList.value.includes(o.split(".")[1])&&a.forEach(r=>r(s))};textRef.value.addEventListener(t,n),removeEvents.push({selector:o,eventType:t,remove:()=>{textRef.value&&textRef.value.removeEventListener(t,n)}})})}))};let lightbox,lightboxTime;const initphotoswipe=()=>{!lightbox&&isImage&&!useChat.sending&&(clearTimeout(lightboxTime),lightboxTime=setTimeout(()=>y(this,null,function*(){const o={gallery:"#TextComp"+props.chat[1].id,childSelector:".gallery__item",pswpModule:()=>__vitePreload(()=>import("./chunk.4zk48.js"),[],import.meta.url),paddingFn:t=>({top:30,bottom:30,left:70,right:70})},e=document.querySelectorAll(".gallery__item");Array.from(e).map(t=>y(this,null,function*(){const a=t.getAttribute("url"),n=t.querySelector("a"),{width:s,height:r}=yield getImgWH(a);n.setAttribute("data-pswp-width",s),n.setAttribute("data-pswp-height",r)})),lightbox=new PhotoSwipeLightbox(o),lightbox.init()}),100))};return onMounted(()=>{initphotoswipe(),window.addEventListener("resize",resize),bindEvent()}),onUnmounted(()=>{clearTimeout(showTimer),clearTimeout(lightboxTime),lightbox&&(lightbox.destroy(),lightbox=null),window.removeEventListener("resize",resize),removeEvents.forEach(o=>o.remove())}),(o,e)=>{var t;return openBlock(),createElementBlock("div",{class:"TextComp",ref_key:"textRef",ref:textRef,id:"TextComp"+((t=props.chat[1])==null?void 0:t.id)},[createBaseVNode("div",{class:"markdown-body",innerHTML:text.value},null,8,_hoisted_2$3)],8,_hoisted_1$3)}}},TextComp=_export_sfc(_sfc_main$3,[["__scopeId","data-v-62a2ee11"]]),rings=""+new URL("rings.d887368f.svg",import.meta.url).href,rings_light=""+new URL("rings_light.7cf522e3.svg",import.meta.url).href,_hoisted_1$2={class:"FileListComp"},_hoisted_2$2={class:"text"},_sfc_main$2={__name:"FileListComp",props:{list:Array},setup(o){const e=o;return(t,a)=>(openBlock(),createElementBlock("div",_hoisted_1$2,[(openBlock(!0),createElementBlock(Fragment,null,renderList(e.list,n=>(openBlock(),createElementBlock("div",{class:"item",key:n},[a[0]||(a[0]=createBaseVNode("div",{class:"other"},[createBaseVNode("span",{class:"iconfont icon-file"})],-1)),createBaseVNode("span",_hoisted_2$2,toDisplayString(n.name),1)]))),128))]))}},_hoisted_1$1=["id"],_hoisted_2$1=["data-id","onClick"],_hoisted_3$1=["href","data-pswp-width","data-pswp-height"],_hoisted_4$1=["src"],_hoisted_5$1={class:"pswp-caption-content"},base=160,_sfc_main$1={__name:"index",props:{galleryID:String,images:Array},setup(o){let e;inject("resize");const t=o,a=ref(null);ref(base);const n=ref(1);computed(()=>{const r=[];for(let i=0;i<n.value;i++)r.push({h:0,images:[]});const c=()=>{let i=1/0,l;for(let p=0;p<r.length;p++)r[p].h<i&&(i=r[p].h,l=p);return{mobj:r[l],i:l}};return t.images.forEach(i=>{const{height:l=300,width:d=300}=i,p=d/150,{mobj:h}=c();h.h+=l/p+10,h.images.push(i)}),r.forEach(({images:i},l)=>{i.forEach((d,p)=>{d._id=l+n.value*p})}),r});const s=()=>{};return onMounted(()=>{if(!e){const r={dataSource:t.images,gallery:"#"+t.galleryID,childSelector:".pswp-gallery__item",pswpModule:()=>__vitePreload(()=>import("./chunk.4zk48.js"),[],import.meta.url),paddingFn:c=>({top:30,bottom:30,left:70,right:70})};e=new PhotoSwipeLightbox(r),new PhotoSwipeDynamicCaption(e,{mobileLayoutBreakpoint:700,type:"auto",mobileCaptionOverlapRatio:1}),e.init()}}),onUnmounted(()=>{e.destroy(),e=null}),(r,c)=>(openBlock(),createElementBlock("div",{id:o.galleryID,ref_key:"wrapper",ref:a,class:"SimpleGallery"},[(openBlock(!0),createElementBlock(Fragment,null,renderList(t.images,(i,l)=>(openBlock(),createElementBlock("div",{class:"pswp-gallery__item",key:l,"data-id":i._id,onClick:d=>s()},[createBaseVNode("a",{onClick:c[0]||(c[0]=withModifiers(()=>{},["prevent"])),href:i.src,"data-pswp-width":i.width,"data-pswp-height":i.height,target:"_blank",rel:"noreferrer"},[createBaseVNode("img",{src:i.thumbnailURL,alt:""},null,8,_hoisted_4$1)],8,_hoisted_3$1),createBaseVNode("div",_hoisted_5$1,toDisplayString(i.userPrompt),1)],8,_hoisted_2$1))),128))],8,_hoisted_1$1))}},SimpleGallery=_export_sfc(_sfc_main$1,[["__scopeId","data-v-37f8bd43"]]),getUrl=o=>y(void 0,null,function*(){return`/voice/text_to_speech_stream?${Object.entries({"tts1.model":"tts-1","tts1.input":o,"tts1.responseFormat":"mp3"}).map(([a,n])=>`${a}=${n}`).join("&")}`});class AudioComp{constructor(){}play(e){return y(this,null,function*(){return new Promise((t,a)=>{this.audio=new Audio,this.audio.addEventListener("ended",t),this.audio.addEventListener("error",n=>{console.log("audio-err",n),a(n)}),this.audio.src=e,this.audio.play()})})}pause(){var e;(e=this.audio)==null||e.pause()}close(){this.pause()}}const playMap=new Map;function useAudioList(){const o=new AudioComp,e={},t=i=>{e[i].forEach(l=>l())};function a(){for(const[i,l]of playMap)r(i)}function n(i){console.log("addd:",i,playMap,playMap.has(i)),playMap.has(i)||(playMap.set(i,{play:!1,url:""}),e[i]=[])}window.playMap=playMap;function s(i,l){return y(this,null,function*(){n(i),a();const d=playMap.get(i);if(d.play=!0,t(i),!d.url){const p=yield getUrl(l);d.url=p}yield o.play(d.url),d.play=!1,t(i)})}function r(i){return y(this,null,function*(){if(!playMap.has(i))return;const l=playMap.get(i);o.pause(),l.play=!1,t(i)})}return{getControl:(i,l)=>{let d=playMap.get(i);return d||(n(i),d=playMap.get(i)),e[i].push(()=>l(d)),{play:(...p)=>y(this,null,function*(){return yield s(i,...p).catch(h=>{throw d.play=!1,t(i),new Error(h)})}),stop:(...p)=>y(this,null,function*(){return yield r(i,...p)}),data:d}},play:s,stop:r,stopAll:a}}const list=useAudioList(),useAudioList$1=()=>list,audioList=useAudioList$1();function getMsgAudio(o,e){return{control:audioList.getControl(o,e)}}const chatAudio={getMsgAudio},MessageBody_vue_vue_type_style_index_0_scoped_0f43fafa_lang="",_hoisted_1={key:0,class:"msg_item quize"},_hoisted_2={class:"flex_b title_row"},_hoisted_3={class:"left"},_hoisted_4=["src"],_hoisted_5={class:"icon"},_hoisted_6={class:"msg_body"},_hoisted_7=["msg-id"],_hoisted_8={class:"flex_b title_row"},_hoisted_9={class:"left"},_hoisted_10=["src"],_hoisted_11={class:"icon"},_hoisted_12={class:"msg_body"},_hoisted_13=["msg-id"],_hoisted_14={class:"text_loading flex"},_hoisted_15=["src"],_sfc_main={__name:"MessageBody",props:["sending","item","end","type"],emits:["change","update:sending","delmsg"],setup(o,{emit:e}){const{getMsgAudio:t}=chatAudio,a=inject("resize"),n=useMessage(),s=useChatStore(),r=useLoginStore(),c=o,i=e,{showToast:l,closeWatch:d,clearWatch:p}=useToast(),h=computed(()=>r.theme=="dark"?rings:rings_light),g=computed(()=>s.currFriendInfo),w=computed(()=>r.user||{name:"我"}),f=computed(()=>{var u;return(u=c.item.chat[0])==null?void 0:u.content}),v=computed(()=>c.item.chat[0]||{}),m=computed(()=>c.item.chat[1]||{}),k=computed(()=>m.value.content),N=computed(()=>{var u;return(u=c.item.chat[0])==null?void 0:u.welcome}),V=computed(()=>m.value.status==500),C=computed(()=>c.type==="share"),I=computed(()=>C.value?"提问":(s.isWeb?w.value.name:"提问")||"提问2"),H=computed(()=>C.value?"回答":(s.isWeb?g.value.name:"回答")||"回答");computed(()=>m.value.play);const S=computed(()=>!a.smallRef.value),j=computed(()=>r.user?r.user.avatar:default_user_avatar),O=computed(()=>s.avater),b=ref([]),x=ref([]);let B=!1;const q=()=>{b.value=[],x.value=[],(v.value.attachments||[]).forEach(_=>y(this,null,function*(){const{mimeType:E,url:L}=_;if(IMG_TYPES.includes(E)){const{width:Z,height:Y}=yield getImgWH(L),G={width:Z,height:Y,src:L,thumbnailURL:L+"?image_process=resize,w_150"};if(B)return;b.value.push(G)}else x.value.push(_)}))},A=ref(!1),D=()=>y(this,null,function*(){const u=t(m.value.id,_=>{A.value=_.play}).control;u.data.play?u.stop():(A.value=!0,console.log("语音文案:",m.value.id),yield u.play(k.value).catch(_=>{console.log("err",_)}))}),R=()=>i("change",{type:"copyQuize",item:c.item}),W=()=>i("change",{type:"reanswer",item:c.item}),F=()=>y(this,null,function*(){yield copyToClip(k.value),n.success("复制成功！")}),U=u=>i("change",{type:"collect",item:c.item,e:u});let T={};onMounted(()=>{q(),d("del",u=>{u&&i("delmsg",T)})}),onUnmounted(()=>{B=!0,p()});const M=u=>y(this,null,function*(){T=c.item.chat[u],l("del","你正在删除这条消息，确定要这样做吗？")});return(u,_)=>(openBlock(),createElementBlock("div",{class:normalizeClass(["MessageBody",{pc:!C.value&&S.value}])},[f.value?(openBlock(),createElementBlock("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[createBaseVNode("div",_hoisted_3,[S.value&&!C.value?(openBlock(),createElementBlock("img",{key:0,class:"avater",src:j.value,alt:""},null,8,_hoisted_4)):createCommentVNode("",!0),createBaseVNode("span",null,toDisplayString(I.value),1)]),withDirectives(createBaseVNode("div",_hoisted_5,[createBaseVNode("span",{class:"hover_light iconfont icon-delete",onClick:_[0]||(_[0]=E=>M(0)),title:"删除提问"}),createBaseVNode("span",{class:"hover_light iconfont icon-edit",onClick:R,title:"编辑提问"})],512),[[vShow,!c.sending&&!C.value]])]),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",{class:"text_wrapper","msg-id":v.value.id},[x.value.length?(openBlock(),createBlock(_sfc_main$2,{key:0,list:x.value},null,8,["list"])):createCommentVNode("",!0),b.value.length?(openBlock(),createBlock(SimpleGallery,{key:1,galleryID:"gallery"+v.value.id,images:b.value},null,8,["galleryID","images"])):createCommentVNode("",!0),createVNode(TextComp,{text:f.value,chat:c.item.chat,type:"quize",mtype:c.type},null,8,["text","chat","mtype"])],8,_hoisted_7)])])):createCommentVNode("",!0),k.value||m.value.loading?(openBlock(),createElementBlock("div",{key:1,class:normalizeClass(["msg_item answer",{status_500:V.value}])},[createBaseVNode("div",_hoisted_8,[createBaseVNode("div",_hoisted_9,[S.value&&!C.value?(openBlock(),createElementBlock("img",{key:0,class:"avater",src:O.value,alt:""},null,8,_hoisted_10)):createCommentVNode("",!0),createBaseVNode("span",null,toDisplayString(H.value),1)]),withDirectives(createBaseVNode("div",_hoisted_11,[C.value?createCommentVNode("",!0):(openBlock(),createElementBlock(Fragment,{key:0},[createBaseVNode("span",{class:"iconfont icon-jushoucang",onClick:U,title:"收藏"}),g.value.voiceChat?(openBlock(),createElementBlock("span",{key:0,class:normalizeClass(["hover_light iconfont",A.value?"icon-bizui":"icon-fayinlianxi"]),onClick:D,title:"语音播放"},null,2)):createCommentVNode("",!0),createBaseVNode("span",{class:"hover_light iconfont icon-delete",onClick:_[1]||(_[1]=E=>M(1)),title:"删除回答"}),o.end?(openBlock(),createElementBlock("span",{key:1,class:"hover_light iconfont icon-refresh",onClick:W,title:"重新回答"})):createCommentVNode("",!0)],64)),createBaseVNode("span",{class:"hover_light iconfont icon-file-copy",onClick:F,title:"复制回答"})],512),[[vShow,!N.value&&!c.sending]])]),createBaseVNode("div",_hoisted_12,[m.value.loading?createCommentVNode("",!0):(openBlock(),createElementBlock("div",{key:0,class:"text_wrapper","msg-id":m.value.id},[createVNode(TextComp,{text:k.value,chat:c.item.chat,type:"answer",cursor:o.end,mtype:c.type},null,8,["text","chat","cursor","mtype"])],8,_hoisted_13)),withDirectives(createBaseVNode("div",_hoisted_14,[createBaseVNode("img",{style:{width:"26px"},class:"loading_svg",src:h.value},null,8,_hoisted_15)],512),[[vShow,m.value.loading]])])],2)):createCommentVNode("",!0)],2))}},MessageBody=_export_sfc(_sfc_main,[["__scopeId","data-v-0f43fafa"]]);export{MessageBody as M,TextComp as T};
